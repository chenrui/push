/*! appstore */
function is_iE(){return!!window.ActiveXObject}$(function(){function a(a,b,c,d,e,f){a.find(".page-li").remove();for(var g=b,h="",i=c>g?g:c,j=1;i>=j;j++)h+=1===j?'<li class="active page-li"><a>'+j+"</a></li>":'<li class="page-li"><a>'+j+"</a></li>";$(h).insertAfter(a.find(".prev")),a.find(".page-li a").click(function(){if(!$(this).parent().hasClass("active")){var g=$(this).html();$.ajax({url:d,type:"GET",data:$.extend({},e,{page:parseInt(g)}),success:function(d){$("#app-mp-check").prop("checked",!1),"function"==typeof f&&f(d);var e=b;if(a.find("li.active").removeClass("active"),a.find("li.disabled").removeClass("disabled"),e>c&&Number(g)>=Math.floor(c/2)+1&&Number(g)<=e-Math.floor(c/2))a.find(".page-li a").each(function(a){$(this).html(Number(g)+a-Math.floor(c/2)),a===Math.floor(c/2)&&$(this).parent().addClass("active")});else if(a.find("li.active").removeClass("active"),Number(g)<Math.floor(c/2)+1)a.find(".page-li a").each(function(a){a+1==g&&$(this).parent().addClass("active"),$(this).html(a+1)});else if(Number(g)>e-Math.floor(c/2)){var h=a.find(".page-li").length;a.find(".page-li a").each(function(a){e-(h-1-a)==g&&$(this).parent().addClass("active"),$(this).html(e-(h-1-a))})}else $(this).parent().addClass("active");1==a.find("li.active a").html()&&a.find("li.prev").addClass("disabled"),a.find("li.active a").html()==e&&a.find("li.next").addClass("disabled")}})}}),a.find("li.prev a").click(function(){$(this).parent().hasClass("disabled")||a.find("li.active").prev().find("a").click()}),a.find("li.next a").click(function(){$(this).parent().hasClass("disabled")||a.find("li.active").next().find("a").click()})}function b(b){$.ajax({url:"/admin/featured/related_apps/query/",type:"GET",data:{app_id:b,page:1},success:function(c){"success"===c.status&&(d(c),0===c.pages?($(".added-app").removeClass("table-bordered"),$("#view-app .pagination").addClass("hidden")):($(".added-app").addClass("table-bordered"),$("#view-app .pagination").removeClass("hidden"),1===c.pages&&$("#view-app .pagination .next").addClass("disabled"),a($("#view-app .pagination"),c.pages,7,"/admin/featured/related_apps/query/",{app_id:b},d)))}})}function c(a){if(0===a.total)return $("#add-app .pagination").addClass("hidden"),$(".search-result .table tbody").html('<tr><td colspan="100%">没有找到相关APP</td><tr>'),void $(".search-result").removeClass("hidden");$("#add-app .pagination").removeClass("hidden"),$(".search-result .table tbody").html("");for(var b=a.items,c="",d=0;d<b.length;d++)c+='<tr><td><input type="checkbox" class="app-mp-check-item" value="'+b[d].id+'" /></td><td>'+b[d].name+"</td><td>"+b[d].provider+"</td></tr>";$(".search-result .table tbody").html(c),$(".search-result").removeClass("hidden")}function d(a){function b(a){switch(a){case 0:return"暂无评星";case.5:return"半星";case 1:return"一星";case 1.5:return"一星半";case 2:return"二星";case 2.5:return"二星半";case 3:return"三星";case 3.5:return"三星半";case 4:return"四星";case 4.5:return"四星半";case 5:return"五星"}}if(0===a.total)return void $(".added-app tbody").html('<tr><td colspan="100%">此应用还没有添加推荐APP</td><tr>');$(".added-app tbody").html("");for(var c=a.items,d="",e=0;e<c.length;e++){var f=b(c[e].stars);d+="<tr><td>"+(10*(a.page-1)+e+1)+'</td><td><img src="'+c[e].icon+'"></td><td>'+c[e].name+"</td><td>"+c[e].provider+"</td><td>"+f+'</td><td><input type="text" class="text-center input-sm input-static recommend-app-priority" data-default="'+c[e].priority+'" name="priority" value="'+c[e].priority+'" data-id="'+c[e].id+'"></td><td><a class="btn btn-xs btn-warning off-added-app" data-id="'+c[e].id+'">下架</a></td></tr>'}$(".added-app tbody").html(d)}bootbox.setDefaults({locale:"zh_CN"}),$.selectAllToggle("banner-check","banner-check-item"),$("#btn-banner-sw").click(function(){var a=$.checkboxVal("banner-check-item");a.length>0?bootbox.confirm("选择下架后，你投放的资源将被移除，是否继续？",function(b){if(b){var c={url:"/admin/ads/offshelf/",data:{ad_ids:a}};$.sendAjax(c)}}):bootbox.alert("请先选择，然后才能进行下架操作!",function(){})}),$(".update_ads_priority").update("/admin/ads/priority/update/"),$.selectAllToggle("mp-check","mp-check-item"),$("#btn-mp-sw").click(function(){var a=$.checkboxVal("mp-check-item"),b=$("#featured_tag").val(),c="/admin/featured/off_shelf/";"necessary"==b&&(c="/admin/necessary/off_shelf/"),a.length>0?bootbox.confirm("选择下架后，你投放的资源将被移除，是否继续？",function(b){if(b){var d=document.getElementById("provider"),e=d.options[d.selectedIndex].value,f={id:a,provider:e};$.sendAjax({url:c,type:"POST",data:f})}}):bootbox.alert("请先选择，然后才能进行下架操作!",function(){})}),$("#btn-dp-sw").click(function(){$(".all-check").prop("checked",!1);try{clearInterval(timer)}catch(a){}$("#dp-yes-btn").html("确定").prop("disabled",!1).removeClass("active"),$.sendAjax({url:"/admin/featured/copyinfo/?from="+$("#phonemodel").val(),type:"GET",callback:function(a){if(a){var b=a.featured_category,c=a.phone_models,d="";$(b).each(function(){d+='<li><label><input class="cate-check-item" type="checkbox" data-id="'+this.id+'" />'+this.name+"</label></li>"}),$(".all-phones>ul").html(d);var e="";$(c).each(function(){e+='<div class="dup-tree checkbox"><label><input class="all-phone-check" title="全选" type="checkbox" data-id="'+this.id+'" />'+this.name+'</label><ul class="clearfix">'+d+"</ul></div>"}),$(".phone_models").html(e),$("#duplicate").modal("show")}else alert("获取机型列表失败，请稍候重试")}})}),$(".all-check").click(function(){var a=$(this).parent().parent().parent();$(this).is(":checked")?(a.find("ul .cate-check-item").prop("checked",!0),a.find(".all-phone-check").prop("checked",!0)):(a.find("ul .cate-check-item").prop("checked",!1),a.find(".all-phone-check").prop("checked",!1))}),$(".all-phones").delegate(".cate-check-item","click",function(){var a=$(".phone_models").find("input[data-id = "+$(this).attr("data-id")+"].cate-check-item");$(this).is(":checked")?a.prop("checked",!0):a.prop("checked",!1)}),$(".phone_models").delegate(".all-phone-check","click",function(){var a=$(this).parent().parent().find(".cate-check-item");$(this).is(":checked")?a.prop("checked",!0):a.prop("checked",!1)}),$("#dp-yes-btn").click(function(){var a=[];if($(".phone_models").find(".all-phone-check").each(function(){var b=$(this).parent().parent().find(".cate-check-item:checked");if(b.length){var c=[],d={};b.each(function(){c.push(parseInt($(this).attr("data-id")))});var e=$(this).attr("data-id");d[e]=c,a.push(d)}}),!a.length)return alert("请选择要复制的机型"),!1;$.sendAjax({url:"/admin/featured/copyinfo/",type:"POST",data:{duplicateData:a,from:$("#phonemodel").val()},callback:function(a){"success"==a.status?(clearInterval(timer),bootbox.alert("复制成功",function(){$.reload()})):bootbox.alert(a.msg)}});var b=0;$("#dp-yes-btn").html("提交中").prop("disabled",!0).addClass("active"),timer=setInterval(function(){b>2?($("#dp-yes-btn").html("提交中"),b=0):($("#dp-yes-btn").html($("#dp-yes-btn").html()+"."),b++)},800)}),$(".featured_priority").update("/admin/featured/update_priority/"),$(".necessary_priority").update("/admin/necessary/update_priority/"),$(".fc_priority").update("/admin/featured_category/priority/update/"),$(".itemperpage").update("","per_page"),$("#provider").change(function(){$(".itemperpage").installUrl("provider",$(this).val())}),$("#phonemodel").change(function(){$(".itemperpage").installUrl("phonemodel",$(this).val())}),$(".tag").update("/admin/featured/update_tag/","tag_id"),$(".btn-modify-tab").click(function(){var a=$(this).parent().parent().find("input[name=category_id]").attr("value");$(".upload_inf").html("").addClass("hidden"),$.sendAjax({url:"/admin/featured_category/detail/?category_id="+a,type:"GET",sync:!1,callback:function(a){if("success"==a.status){$("#category-name").val(a.category.name),$("#input-category-id").val(a.category.id),$("#input-fc-icon").val(a.category.icon);var b='<div><img  src="'+a.category.icon+'" class="upload_image img-thumbnail" /></div>';$("#icon-path").val(a.category.icon),$("#preview-icon").html(b).removeClass("hidden"),$(".check-icon").removeClass("hidden"),$("#choose-icon").attr("title",a.category.icon),$("#tab-modify").modal("show")}else bootbox.alert("修改失败")}})}),$(".add-app").click(function(){$("input[name=app_name]").val(""),$(".search-result .table tbody").html(""),$(".page-li").remove(),$(".search-result").addClass("hidden"),$("#add-app input[name=master_app_id]").val($(this).attr("data-value")),$("#add-app").modal("show")}),$("input[name=app_name]").keypress(function(a){var b=a.charCode||a.keyCode;13===b&&$(".search-app").click()}),$(".search-app").click(function(){var b=null;$.ajax({url:"/admin/featured/related_apps/",type:"GET",data:{app_name:$.trim($("input[name=app_name]").val()),page:1},beforeSend:function(){b=setTimeout(function(){$(".search-app").html("查找中...")},200)},success:function(b){"success"===b.status?(c(b),a($(".search-result .pagination"),b.pages,7,"/admin/featured/related_apps/",{app_name:$.trim($("input[name=app_name]").val())},c)):alert(b.msg)},error:function(){alert("搜索好像出问题了...请再试一下")},complete:function(){b&&clearTimeout(b),$(".search-app").html("查找")}})}),$("#add-app-btn").click(function(){var a=$.checkboxVal("app-mp-check-item");a.length>0?$.ajax({url:"/admin/featured/related_apps/",type:"POST",contentType:"application/json",data:JSON.stringify({master_app_id:+$("#add-app input[name=master_app_id]").val(),related_app_ids:a}),success:function(a){"success"===a.status?(alert("添加成功"),$("#add-app").modal("hide")):alert(a.msg)},error:function(){alert("添加出错")}}):alert("请选择要添加的应用")}),$(".view-app").click(function(){$("#view-app .modal-title .app-name").html($(this).parent().parent().find(".app-name").html()),$("#view-app input[name=master_app_id]").val($(this).attr("data-value")),$("#view-app").modal("show");var a=+$(this).attr("data-value");b(a)}),$(".added-app").delegate(".off-added-app","click",function(){var a=this;confirm("确认要下架该APP吗？")&&$.ajax({url:"/admin/featured/related_apps/delete/",type:"POST",contentType:"application/json",data:JSON.stringify({master_app_id:+$("#view-app input[name=master_app_id]").val(),related_app_id:+$(a).attr("data-id")}),success:function(a){"success"===a.status&&b(+$("#view-app input[name=master_app_id]").val())}})}),$(".added-app").delegate(".recommend-app-priority","blur",function(){if(""===$.trim($(this).val()))return $(this).val($(this).attr("data-default")),!1;if(!+$(this).val())return alert("排序只能为1~9999的数字"),$(this).val($(this).attr("data-default")),!1;if($(this).val()<1||$(this).val()>9999)return alert("排序取值范围为1~9999"),$(this).val($(this).attr("data-default")),!1;var a=this;$.ajax({url:"/admin/featured/related_apps/query/",type:"POST",contentType:"application/json",data:JSON.stringify({master_app_id:+$("#view-app input[name=master_app_id]").val(),related_app_id:+$(a).attr("data-id"),priority:+$(a).val()}),success:function(a){"success"===a.status&&b(+$("#view-app input[name=master_app_id]").val())}})}),$.selectAllToggle("app-mp-check","app-mp-check-item"),$(".imgpreviews").imgPreview(),$("#btn-modify-category").click(function(){var a=$("#category-name"),b=$.trim(a.val()),c=/^[\u4E00-\u9FA5\uf900-\ufa2d]{1,3}$|^[A-Za-z0-9_]{1,6}$/;if(""==b)return bootbox.alert("请输入名称！"),a.focus(),!1;if(!c.test(b))return bootbox.alert("请输入1-3个汉字或1-6个英文字母！"),a.focus(),!1;if($.isNull($("#icon-path").val())){var d="";return d=""===$("#preview-icon").html()?"请选择Icon":"请上传icon",bootbox.alert(d),!1}$.ajax({url:"/admin/featured_category/modify/",data:$("#form_modify_tab").serialize(),type:"POST",sync:!1,success:function(a){"success"==a.status?location.href=window.location.protocol+"//"+window.location.host+"/admin/featured_category/custom/":alert("修改失败")},error:function(a){bootbox.alert("请求失败: "+a.statusText+"("+a.status+")")}})});try{var e=Qiniu.uploader({runtimes:"html5,flash,html4",browse_button:"choose-icon",uptoken_url:"/admin/qiniu/token",domain:"tcl-cd-test.qiniudn.com",container:"container-icon",max_file_size:"100kb",flash_swf_url:"../../../../static/plugin/qiniu/js/plupload/Moxie.swf",max_retries:0,dragdrop:!1,auto_start:!1,multi_selection:!1,unique_names:!0,save_key:!0,init:{FilesAdded:function(a,b){if(b[0].type.indexOf("image")<0)return a.files.pop(),alert("请上传图片文件"),!1;a.files.length>1&&a.files.shift();var c=a.files[0],d="",f=a.settings,g=$(f.browse_button[0]),h=g.parent().parent().find(".upload_preview"),i=g.parent().parent().find(".progress-bar"),j=g.parent().parent().find(".progress"),k=g.parent().parent().find(".file-submit"),l=(g.parent().parent().find(".file-abort"),g.parent().find("i.check-icon")),m=g.parent().parent().find(".upload_inf"),n=$("#icon-path"),o=new FileReader;o.onload=function(b){d='<div><a class="upload_delete close glyphicon glyphicon-remove" title="删除"></a><img  src="'+b.target.result+'" class="upload_image img-thumbnail" /></div>',h.html(d).removeClass("hidden"),i.css("width","0"),j.removeClass("hidden"),g.attr("title",c.name),k.removeClass("hidden"),l.addClass("hidden"),m.html("").addClass("hidden"),h.delegate(".upload_delete","click",function(){a.files.pop(),l.addClass("hidden"),h.html("").addClass("hidden"),i.css("width","0"),j.addClass("hidden"),k.addClass("hidden"),g.attr("title","未选择文件"),n.val(""),m.html("").addClass("hidden")}),n.val(""),k[0].onclick=function(){m.html("").addClass("hidden"),e.start()}},o.readAsDataURL(c.getNative())},BeforeUpload:function(a){var b=a.settings,c=$(b.browse_button[0]),d=c.parent().parent().find(".progress"),f=c.parent().parent().find(".progress-bar"),g=c.parent().parent().find(".file-submit"),h=c.parent().parent().find(".file-abort"),i=c.parent().parent().find(".upload_delete"),j=c.parent().parent().find(".upload_inf");g.addClass("hidden"),h.removeClass("hidden"),i.addClass("hidden"),d.addClass("active"),h.click(function(){e.stop(),f.css("width","0"),$(this).addClass("hidden"),g.removeClass("hidden"),j.html('<i class="icon-warning-sign"> 文件上传失败：用户终止上传').removeClass("hidden")})},UploadProgress:function(a,b){var c=a.settings,d=$(c.browse_button[0]),e=(d.parent().parent().find(".file-abort"),d.parent().parent().find(".progress-bar"));e.css("width",b.percent+"%")},FileUploaded:function(a,b,c){var d=$.parseJSON(c);if(!d)return void bootbox.alert("上传专题icon文件失败");$("#icon-path").val(d.key+","+d.name);var e=a.settings,f=$(e.browse_button[0]),g=f.parent().parent().find(".progress"),h=(f.parent().parent().find(".file-submit"),f.parent().parent().find(".file-abort")),i=f.parent().parent().find(".upload_delete"),j=f.parent().find("i.check-icon");h.addClass("hidden"),i.removeClass("hidden"),j.removeClass("hidden"),g.removeClass("active")},Error:function(a,b,c){var d=a.settings,e=$(d.browse_button[0]),f=(e.parent().parent().find(".file-submit"),e.parent().parent().find(".file-abort")),g=e.parent().parent().find(".progress"),h=e.parent().parent().find(".upload_delete"),i=e.parent().find("i.check-icon"),j=$("#video_cover_name"),k=e.parent().parent().find(".upload_inf");h.removeClass("hidden"),f.addClass("hidden"),i.addClass("hidden"),j.val(""),g.removeClass("active"),k.html('<i class="icon-warning-sign"> '+c).removeClass("hidden")},UploadComplete:function(){}}})}catch(f){}});