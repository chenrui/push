/*! appstore */
function is_iE(){return!!window.ActiveXObject}$(function(){bootbox.setDefaults({locale:"zh_CN"}),$("#adres_app_category").change(function(){var a=$(this).val();return $.isNumber(a)?void $.sendAjax({url:"/admin/app/sub_category/"+a+"/",data:"",callback:function(a){a=a.data;var b=$("#adres_app_sub_category");b.empty(),b.append($("<option value=''>请选择</option>"));for(var c=0;c<a.length;c++)b.append($("<option value='"+a[c].id+"'>"+a[c].name+"</option>"))}}):void $("#adres_app_sub_category").html('<option value="">请选择</option>')}),$.selectAllToggle("ad-res-check","ad-res-check-item"),$("#sf-del-sw").click(function(){var a=$.checkboxVal("ad-res-check-item");a.length>0?bootbox.confirm("确实要删除所选项到回收站吗？",function(b){b&&$.sendAjax({url:"/admin/app/delete/",type:"POST",data:a})}):bootbox.alert("请先选择App，然后才能进行删除!",function(){})}),$("#sf-throw-sw").click(function(){$(".result-box .jtree").html(""),$(".selected-count").html("0"),$("#throw-yes-btn").html("确定");var a=$.checkboxVal("ad-res-check-item");if($("#throw-tree").html(""),!(a.length>0))return void bootbox.alert("请先选择App，然后才能进行投放!",function(){});$("#app-throw").modal("show");var b={url:"/admin/throw_app/info",type:"GET",callback:function(a){$(".modal-footer").show(),$("#throw-tree").throwTree(a.data),$("ul.has-children").parent().find(">.glyphicon").css("display","none")}};$.sendAjax(b)}),$("#throw-tree").delegate(".add-block","click",function(){var a=$(this).parent();if(a.find(">ul.has-children").length){var b=a.find(">ul.has-children>li"),c=function(a){return a.each(function(){if($(this).find(">ul.has-children").length)a=$(this).find(">ul.has-children>li"),c(a);else{var b=$('<li class="list-group-item" data-id="'+$(this).attr("data-id")+'" data-type="'+$(this).attr("data-type")+'"><a class="glyphicon glyphicon-chevron-left pull-right remove-block" title="移除版块"></a></li>'),d=b.html(),e=$(this).treeDepth();e.reverse();for(var f=0;f<e.length;f++)0==f?d+=e[f]:d=d+" > "+e[f];b.html(d+" > "+$(this).attr("data-txt")),b.appendTo($(".result-box ul")),$(this).hide();var g=parseInt($(".selected-count").html());$(".selected-count").html(++g)}}),a};c(b)}else{var d=a.treeDepth();d.reverse();for(var e=$('<li class="list-group-item" data-id="'+a.attr("data-id")+'" data-type="'+a.attr("data-type")+'"><a class="glyphicon glyphicon-chevron-left pull-right remove-block" title="移除版块"></a></li>'),f=e.html(),g=0;g<d.length;g++)0==g?f+=d[g]:f=f+" > "+d[g];e.html(f+" > "+a.attr("data-txt")),e.appendTo($(".result-box ul")),a.hide();var h=parseInt($(".selected-count").html());$(".selected-count").html(++h)}}),$(".result-box").delegate(".remove-block","click",function(){var a,b,c,d;if($(this).parent().find("ul.has-children").length)a=$(this).parent().attr("data-id"),b=$(".choose-box").find("li.list-group-item[data-id="+a+"]").find("ul.has-children"),c=parseInt($(".selected-count").html())-$(this).parent().find("ul.has-children>li").length,$(this).parent().find("ul.has-children li").appendTo(b),$(this).parent().remove();else{d=$(this).parent().text().split(" > ");var e=$(this),f=$(".choose-box");$(d).each(function(a){a!==d.length-1?f=f.find('li[data-txt="'+d[a]+'"]'):(f.find('li[data-txt="'+d[a]+'"]').show(),e.parent().remove(),c=parseInt($(".selected-count").html())-1)})}$(".selected-count").html(c)}),$(".publish-status").changeStatus("app_publish_status"),$("#throw-yes-btn").click(function(){var a=$(this),b=[];$(".result-box li").each(function(){var a={},c=$(this).text().split(" > ");a.name=c[c.length-1],a.node_type=$(this).attr("data-type"),a.value=parseInt($(this).attr("data-id")),b.push(a)});var c=$.checkboxVal("ad-res-check-item"),d={};if(0==b.length)return void bootbox.alert("请先选择要投放的模块，然后才能进行投放!",function(){});d.sections=b,d.apks=c,d.phone=parseInt($(".phone-list").val());var e={url:"/admin/throw_app/info",data:d,callback:function(b){"success"==b.status?($("#app-throw").modal("hide"),bootbox.alert(b.msg,function(){$.reload()})):(bootbox.alert(b.msg,function(){}),a.prop("disabled",!1).html("确定"))},error:function(b){bootbox.alert("投放失败: "+b.statusText+"("+b.status+")"),a.prop("disabled",!1).html("确定")}};a.prop("disabled",!0).html("投放中"),$.sendAjax(e)}),$(".module_tree").click(function(){var a=$(this).attr("name"),b={url:"/admin/module_tree/"+a+"/",callback:function(a){$("#thrown-tree").html(""),$("#app-thrown").modal("show"),$(".modal-footer").hide(),$("#thrown-tree").moduleTree(a.data)}};$.sendAjax(b)}),$("#sf-down-sw").click(function(){var a=$.checkboxVal("ad-res-check-item");a.length>0?bootbox.confirm("选择下架后，你投放的资源将被移除，是否继续？",function(b){b&&$.sendAjax({url:"/admin/app/offshelf/",type:"POST",data:a})}):bootbox.alert("请先选择App，然后才能进行下架操作!",function(){})}),$.selectAllToggle("cycle-check","cycle-check-item"),$("#sf-cy-re-sw").click(function(){var a=$.checkboxVal("cycle-check-item");a.length>0?bootbox.confirm("确定还原选中的选项吗？",function(b){b&&$.sendAjax({url:"/admin/app/offshelf/",type:"POST",data:a})}):bootbox.alert("请先选择App，然后才能进行还原操作!",function(){})}),$("#sf-cy-del-sw").click(function(){var a=$.checkboxVal("cycle-check-item");a.length>0?bootbox.confirm("删除后将不能再找回，确定要删除吗？",function(b){b&&$.sendAjax({url:"/admin/app_recyclebin/delete/",type:"POST",data:a})}):bootbox.alert("请先选择App，然后才能进行删除操作!",function(){})}),$("#upload-modify-reset").click(function(){k=0,$("#upload-submit").attr("disabled",!1),$("#upload-submit").find("img").addClass("hidden")});var a,b={resizeType:0,minWidth:420,items:["fontname","fontsize","|","forecolor","bold","italic","underline","|","justifyleft","justifycenter","justifyright","justifyfull","|","insertorderedlist","insertunorderedlist","|","indent","outdent"]},c=function(a,b,c,d){var e={url:"/admin/uploadappForm/update/"+a+"/",data:{app_type:c},callback:function(c){if("language"==a){for(var e=0;e<c.data.length;e++)b+="<input type='checkbox' name='checked[]' value='"+c.data[e].id+"'>"+c.data[e].name+"&nbsp;";$("#"+a).html(b),d&&$("[name='checked[]']").each(function(){for(var a=0;a<d.length;a++)d[a]==$(this).attr("value")&&$(this).attr("checked",!0)})}else if("provider"==a){for(var e=0;e<c.data.length;e++)"自有"==c.data[e].name&&(b+="<option value='"+c.data[e].id+"'>"+c.data[e].name+"</option>");b+="</select>",$("#"+a).html(b),d&&$("[name="+a+"]").val(d)}else if("category"==a){for(var e=0;e<c.data.length;e++)b+="<option value='"+c.data[e].id+"'>"+c.data[e].name+"</option>";b+="</select>",$("#"+a).html(b),d&&$("[name="+a+"]").val(d)}}};return e};$("#app-upload-btn").click(function(){i=0,$("#app-upload-modify-title").html("<i class='glyphicon glyphicon-upload'></i>App上传");var d="<select multiple='multiple' name='category' class='form-control input-sm' style='height: 100px;'>";$.sendAjax(c("category",d,0)),d="<select name='provider' class='form-control input-sm'>",$.sendAjax(c("provider",d)),$("#pay_type").hide(),$("#price-percent").hide(),$("#upload-modify")[0].reset(),$("#app_type").removeClass("hidden"),$("#category_tr").removeClass("hidden"),$(".hid").removeClass("hidden"),$("img.check").addClass("hidden"),$("img.check").attr("src",""),$("#option").attr("value","upload"),$(".btn-sfc-del").parent().parent().parent().remove(),$(".upload_preview").html("").addClass("hidden"),$(".path").val(""),$(".progress").addClass("hidden"),$(".check-icon").addClass("hidden"),$("#apkinfo").html("支持安卓系统的安装包，后缀格式为.apk"),a||(a=KindEditor.create("#app-desc-info",b)),a.sync(),a.html(""),$("#name-dsc").html(""),$("#source_type").val(1),$("#pay_type").show(),$("#price-percent").show(),$(".modal-footer").show(),$("#app-upload").modal("show")}),$("#app_type").change(function(){var a="<select multiple='multiple' name='category' class='form-control input-sm' style='height: 100px;'>";$.sendAjax(c("category",a,$("[name=app_type]").val()))}),$("#source_type").change(function(){0==$("#source_type").val()?($("#pay_type").hide(),$("#price-percent").hide()):1==$("#source_type").val()&&($("#pay_type").show(),$("#price-percent").show())}),$("[name=pay_type]").change(function(){"0"==$("[name=pay_type]").val()?$("#price-percent").html("<td>单价</td><td><input type='text' name='price' placeholder='/' class='form-control input-sm'/></td><td></td><td></td>"):"1"==$("[name=pay_type]").val()&&$("#price-percent").html("<td><span style='color: red;'>*</span>&nbsp;分成比例</td><td><input type='text' name='percent' placeholder='/' class='form-control input-sm'/></td><td></td><td></td>")});var d=Qiniu.uploader({runtimes:"html5,flash,html4",browse_button:"choose-icon",uptoken_url:"/admin/qiniu/token",domain:"tcl-cd-test.qiniudn.com",container:"container-icon",max_file_size:"30kb",flash_swf_url:"../../../../static/plugin/qiniu/js/plupload/Moxie.swf",max_retries:0,dragdrop:!1,auto_start:!1,multi_selection:!1,unique_names:!0,save_key:!0,init:{FilesAdded:function(a,b){if(b[0].type.indexOf("png")<0)return a.files.pop(),alert("请上传png图片"),!1;if(b[0].size>30720)return a.files.pop(),alert("文件过大"),!1;a.files.length>1&&a.files.shift();var c=a.files[0],e="",f=a.settings,g=$(f.browse_button[0]),h=g.parent().parent().find(".upload_preview"),i=g.parent().parent().find(".progress-bar"),j=g.parent().parent().find(".progress"),k=g.parent().parent().find(".file-submit"),l=(g.parent().parent().find(".file-abort"),g.parent().find("i.check-icon")),m=g.parent().parent().find(".upload_inf"),n=$("#icon-path"),o=new FileReader;o.onload=function(b){e='<div><a class="upload_delete close glyphicon glyphicon-remove" title="删除"></a><img  src="'+b.target.result+'" class="upload_image img-thumbnail" /></div>',h.html(e).removeClass("hidden"),i.css("width","0"),j.removeClass("hidden"),g.attr("title",c.name),k.removeClass("hidden"),l.addClass("hidden"),m.html("").addClass("hidden"),h.delegate(".upload_delete","click",function(){a.files.pop(),l.addClass("hidden"),h.html("").addClass("hidden"),i.css("width","0"),j.addClass("hidden"),k.addClass("hidden"),g.attr("title","未选择文件"),n.val(""),m.html("").addClass("hidden")}),n.val(""),k[0].onclick=function(){m.html("").addClass("hidden"),d.start()}},o.readAsDataURL(c.getNative())},BeforeUpload:function(a){var b=a.settings,c=$(b.browse_button[0]),e=c.parent().parent().find(".progress"),f=c.parent().parent().find(".progress-bar"),g=c.parent().parent().find(".file-submit"),h=c.parent().parent().find(".file-abort"),i=c.parent().parent().find(".upload_delete"),j=c.parent().parent().find(".upload_inf");g.addClass("hidden"),h.removeClass("hidden"),i.addClass("hidden"),e.addClass("active"),h.click(function(){d.stop(),f.css("width","0"),$(this).addClass("hidden"),g.removeClass("hidden"),j.html('<i class="icon-warning-sign"> 文件上传失败：用户终止上传').removeClass("hidden")})},UploadProgress:function(a,b){var c=a.settings,d=$(c.browse_button[0]),e=(d.parent().parent().find(".file-abort"),d.parent().parent().find(".progress-bar"));e.css("width",b.percent+"%")},FileUploaded:function(a,b,c){var d=$.parseJSON(c);if(!d)return void bootbox.alert("上传专题icon文件失败");$("#icon-path").val(d.key+","+d.name);var e=a.settings,f=$(e.browse_button[0]),g=f.parent().parent().find(".progress"),h=(f.parent().parent().find(".file-submit"),f.parent().parent().find(".file-abort")),i=f.parent().parent().find(".upload_delete"),j=f.parent().find("i.check-icon");h.addClass("hidden"),i.removeClass("hidden"),j.removeClass("hidden"),g.removeClass("active")},Error:function(a,b,c){var d=a.settings,e=$(d.browse_button[0]),f=(e.parent().parent().find(".file-submit"),e.parent().parent().find(".file-abort")),g=e.parent().parent().find(".progress"),h=e.parent().parent().find(".upload_delete"),i=e.parent().find("i.check-icon"),j=$("#video_cover_name"),k=e.parent().parent().find(".upload_inf");h.removeClass("hidden"),f.addClass("hidden"),i.addClass("hidden"),j.val(""),g.removeClass("active"),k.html('<i class="icon-warning-sign"> '+c).removeClass("hidden")},UploadComplete:function(){}}}),e=Qiniu.uploader({runtimes:"html5,flash,html4",browse_button:"choose-banner",uptoken_url:"/admin/qiniu/token",domain:"tcl-cd-test.qiniudn.com",container:"container-banner",max_file_size:"500kb",flash_swf_url:"../../../../static/plugin/qiniu/js/plupload/Moxie.swf",max_retries:0,dragdrop:!1,auto_start:!1,multi_selection:!1,unique_names:!0,save_key:!0,init:{FilesAdded:function(a,b){if(b[0].type.indexOf("image")<0)return a.files.pop(),alert("请上传图片文件"),!1;if(b[0].size>51200)return a.files.pop(),alert("文件过大"),!1;a.files.length>1&&a.files.shift();var c=a.files[0],d="",f=a.settings,g=$(f.browse_button[0]),h=g.parent().parent().find(".upload_preview"),i=g.parent().parent().find(".progress-bar"),j=g.parent().parent().find(".progress"),k=g.parent().parent().find(".file-submit"),l=(g.parent().parent().find(".file-abort"),g.parent().find("i.check-icon")),m=g.parent().parent().find(".upload_inf"),n=$("#banner-path"),o=new FileReader;o.onload=function(b){d='<div><a class="upload_delete close glyphicon glyphicon-remove" title="删除" ></a><img  src="'+b.target.result+'" class="upload_image img-thumbnail" /></div>',h.html(d).removeClass("hidden"),i.css("width","0"),j.removeClass("hidden"),g.attr("title",c.name),k.removeClass("hidden"),l.addClass("hidden"),m.html("").addClass("hidden"),h.delegate(".upload_delete","click",function(){a.files.pop(),l.addClass("hidden"),h.html("").addClass("hidden"),i.css("width","0"),j.addClass("hidden"),k.addClass("hidden"),g.attr("title","未选择文件"),n.val(""),m.html("").addClass("hidden")}),n.val(""),k[0].onclick=function(){m.html("").addClass("hidden"),e.start()}},o.readAsDataURL(c.getNative())},BeforeUpload:function(a){var b=a.settings,c=$(b.browse_button[0]),d=c.parent().parent().find(".progress"),f=c.parent().parent().find(".progress-bar"),g=c.parent().parent().find(".file-submit"),h=c.parent().parent().find(".file-abort"),i=c.parent().parent().find(".upload_delete"),j=c.parent().parent().find(".upload_inf");g.addClass("hidden"),h.removeClass("hidden"),i.addClass("hidden"),d.addClass("active"),h.click(function(){e.stop(),f.css("width","0"),$(this).addClass("hidden"),g.removeClass("hidden"),j.html('<i class="icon-warning-sign"> 文件上传失败：用户终止上传').removeClass("hidden")})},UploadProgress:function(a,b){var c=a.settings,d=$(c.browse_button[0]),e=(d.parent().parent().find(".file-abort"),d.parent().parent().find(".progress-bar"));e.css("width",b.percent+"%")},FileUploaded:function(a,b,c){var d=$.parseJSON(c);if(!d)return void bootbox.alert("上传专题banner文件失败");$("#banner-path").val(d.key+","+d.name);var e=a.settings,f=$(e.browse_button[0]),g=f.parent().parent().find(".progress"),h=(f.parent().parent().find(".file-submit"),f.parent().parent().find(".file-abort")),i=f.parent().parent().find(".upload_delete"),j=f.parent().find("i.check-icon");h.addClass("hidden"),i.removeClass("hidden"),j.removeClass("hidden"),g.removeClass("active")},Error:function(a,b,c){var d=a.settings,e=$(d.browse_button[0]),f=(e.parent().parent().find(".file-submit"),e.parent().parent().find(".file-abort")),g=e.parent().parent().find(".progress"),h=e.parent().parent().find(".upload_delete"),i=e.parent().find("i.check-icon"),j=$("#video_cover_name"),k=e.parent().parent().find(".upload_inf");h.removeClass("hidden"),f.addClass("hidden"),i.addClass("hidden"),j.val(""),g.removeClass("active"),k.html('<i class="icon-warning-sign"> '+c).removeClass("hidden")},UploadComplete:function(){}}}),f=Qiniu.uploader({runtimes:"html5,flash,html4",browse_button:"choose-ss-1",uptoken_url:"/admin/qiniu/token",domain:"tcl-cd-test.qiniudn.com",container:"container-ss-1",max_file_size:"100kb",flash_swf_url:"../../../../static/plugin/qiniu/js/plupload/Moxie.swf",max_retries:0,dragdrop:!1,auto_start:!1,multi_selection:!1,unique_names:!0,save_key:!0,init:{FilesAdded:function(a,b){if(b[0].type.indexOf("image")<0)return a.files.pop(),alert("请上传图片文件"),!1;if(b[0].size>102400)return a.files.pop(),alert("文件过大"),!1;a.files.length>1&&a.files.shift();var c=a.files[0],d="",e=a.settings,g=$(e.browse_button[0]),h=g.parent().parent().find(".upload_preview"),i=g.parent().parent().find(".progress-bar"),j=g.parent().parent().find(".progress"),k=g.parent().parent().find(".file-submit"),l=(g.parent().parent().find(".file-abort"),g.parent().find("i.check-icon")),m=g.parent().parent().find(".upload_inf"),n=$("#screenshot-path-1"),o=new FileReader;o.onload=function(b){d='<div><a class="upload_delete close glyphicon glyphicon-remove" title="删除" ></a><img  src="'+b.target.result+'" class="upload_image img-thumbnail" /></div>',h.html(d).removeClass("hidden"),i.css("width","0"),j.removeClass("hidden"),g.attr("title",c.name),k.removeClass("hidden"),l.addClass("hidden"),m.html("").addClass("hidden"),h.delegate(".upload_delete","click",function(){a.files.pop(),l.addClass("hidden"),h.html("").addClass("hidden"),i.css("width","0"),j.addClass("hidden"),k.addClass("hidden"),g.attr("title","未选择文件"),n.val(""),m.html("").addClass("hidden")}),n.val(""),k[0].onclick=function(){m.html("").addClass("hidden"),f.start()}},o.readAsDataURL(c.getNative())},BeforeUpload:function(a){var b=a.settings,c=$(b.browse_button[0]),d=c.parent().parent().find(".progress"),e=c.parent().parent().find(".progress-bar"),g=c.parent().parent().find(".file-submit"),h=c.parent().parent().find(".file-abort"),i=c.parent().parent().find(".upload_delete"),j=c.parent().parent().find(".upload_inf");g.addClass("hidden"),h.removeClass("hidden"),i.addClass("hidden"),d.addClass("active"),h.click(function(){f.stop(),e.css("width","0"),$(this).addClass("hidden"),g.removeClass("hidden"),j.html('<i class="icon-warning-sign"> 文件上传失败：用户终止上传').removeClass("hidden")})},UploadProgress:function(a,b){var c=a.settings,d=$(c.browse_button[0]),e=(d.parent().parent().find(".file-abort"),d.parent().parent().find(".progress-bar"));e.css("width",b.percent+"%")},FileUploaded:function(a,b,c){var d=$.parseJSON(c);if(!d)return void bootbox.alert("上传截图失败");$("#screenshot-path-1").val(d.key+","+d.name);var e=a.settings,f=$(e.browse_button[0]),g=f.parent().parent().find(".progress"),h=(f.parent().parent().find(".file-submit"),f.parent().parent().find(".file-abort")),i=f.parent().parent().find(".upload_delete"),j=f.parent().find("i.check-icon");h.addClass("hidden"),i.removeClass("hidden"),j.removeClass("hidden"),g.removeClass("active")},Error:function(a,b,c){var d=a.settings,e=$(d.browse_button[0]),f=(e.parent().parent().find(".file-submit"),e.parent().parent().find(".file-abort")),g=e.parent().parent().find(".progress"),h=e.parent().parent().find(".upload_delete"),i=e.parent().find("i.check-icon"),j=$("#screenshot-path-1"),k=e.parent().parent().find(".upload_inf");h.removeClass("hidden"),f.addClass("hidden"),i.addClass("hidden"),j.val(""),g.removeClass("active"),k.html('<i class="icon-warning-sign"> '+c).removeClass("hidden")},UploadComplete:function(){}}}),g=function(a,b,c,d){var e={url:"/admin/uploadFile/check/"+a+"/"+j+"/"+d+"/",secureuri:!1,fileElementId:b,dataType:"json",beforeSend:function(){},success:function(e){1==e.success&&1==k?("apk"==a&&"upload"==d?($("#"+c).parent().find("img").attr("src","/static/common/images/right.png"),$("#apkinfo").html("包名: "+e.apkinfo.package_name+"</br>版本: "+e.apkinfo.version_name+"</br>大小: "+Math.round(e.apkinfo.size/1024/1024*100)/100+"M"),$("#"+c).parent().parent().find("input[type=hidden]").attr("value",e.imgpath)):"apk"==a&&"modify"==d?($("#"+c).parent().find("img").attr("src","/static/common/images/error.png"),bootbox.alert("你修改的apk和服务器不是同一个文件, 必须修改同一个apk(不同版本)")):($("#"+c).parent().find("img").attr("src",e.imgpath),$("#"+c).parent().parent().find("input[type=hidden]").attr("value",e.imgpath)),$("#"+c).parent().find("img").removeClass("hidden")):-1==e.success?($("#"+c).parent().find("img").attr("src","/static/common/images/error.png"),$("#"+c).parent().find("img").removeClass("hidden"),bootbox.alert("网络失败,请重新上传")):0==e.success&&1==k?("apk"==a?($("#"+c).parent().find("img").attr("src","/static/common/images/right.png"),$("#apkinfo").html("包名: "+e.apkinfo.package_name+"</br>版本: "+e.apkinfo.version_name+"</br>大小: "+Math.round(e.apkinfo.size/1024/1024*100)/100+"M"),$("#"+c).parent().parent().find("input[type=hidden]").attr("value",e.imgpath)):($("#"+c).parent().find("img").attr("src","/static/common/images/error.png"),bootbox.alert(e.msg)),$("#"+c).parent().find("img").removeClass("hidden")):-2==e.success&&($("#"+c).parent().find("img").attr("src","/static/common/images/error.png"),bootbox.alert(e.msg),$("#"+c).parent().find("img").removeClass("hidden")),"icon-file-input"==b?$("#icon-file-input").change(function(){var a=$(this).parent().parent().find("input[type='text']");return $.checkFileSuffix($("#icon-file-input")[0].val(),"png")?($("#btn-icon-select").parent().find("img").attr("src","/static/common/images/loading.gif"),$("#btn-icon-select").parent().find("img").removeClass("hidden"),$.ajaxFileUpload(g("icon","icon-file-input","btn-icon-select")),void a.val($(this).val())):void alert("请上传.png格式文件")}):"banner-file-input"==b?$("#banner-file-input").change(function(){var a=$(this).parent().parent().find("input[type='text']");return $.checkFileSuffix($("#banner-file-input").val(),"img")?($("#btn-banner-select").parent().find("img").attr("src","/static/common/images/loading.gif"),$("#btn-banner-select").parent().find("img").removeClass("hidden"),$.ajaxFileUpload(g("banner","banner-file-input","btn-banner-select")),void a.val($(this).val())):void alert("请上传.png或者.jpg文件")}):"screenshot-file-input"==b?$("#screenshot-file-input").change(function(){var a=$(this).parent().parent().find("input[type='text']");return $.checkFileSuffix($(this).val(),"img")?($("#btn-screen-select").parent().find("img").attr("src","/static/common/images/loading.gif"),$("#btn-screen-select").parent().find("img").removeClass("hidden"),$.ajaxFileUpload(g("screenshot","screenshot-file-input","btn-screen-select")),void a.val($(this).val())):void alert("请上传.png或者.jpg文件")}):"sfpak-file-input"==b?$("#sfpak-file-input").change(function(){var a=$(this).parent().parent().find("input[type='text']");return $.checkFileSuffix($("#sfpak-file-input").val(),"apk")?($("#btn-sfpak-select").parent().find("img").attr("src","/static/common/images/loading.gif"),$("#btn-sfpak-select").parent().find("img").removeClass("hidden"),$.ajaxFileUpload(g("apk","sfpak-file-input","btn-sfpak-select",$("#option").attr("value"))),void a.val($(this).val())):void alert("请上传.apk文件")}):$(".screenshot-file-input").change(function(){var a=$(this).parent().parent().find("input[type='text']");return $.checkFileSuffix($(this).val(),"img")?($(this).parent().find("img").attr("src","/static/common/images/loading.gif"),$(this).parent().find("img").removeClass("hidden"),$.ajaxFileUpload(g("screenshot",this.id,this.previousSibling.id)),void a.val($(this).val())):void alert("请上传.png或者.jpg文件")})}};return e};$("[name=publisher]").blur(function(){$.isNull($(this).val())?bootbox.alert("输入不能为空"):$.strLength($(this).val())});var h,i=0;$("#btn-sfc-add").click(function(){if(i>4)return void bootbox.alert("软件截图最多上传6张！");var a="s"+Date.parse(new Date)+$.parseInt($.random(1e3,9999)),b=$("<tr><td><span class='hid' style='color: red;'>*</span>&nbsp;</td><td colspan='2' style='position:relative'><div class=\"td-container btn-group\" id=\"container-ss-"+a+'"><a class="btn btn-default btn-sm fileinput-button" id="choose-ss-'+a+'" title="未选择文件">选择截图</a><input type="button" class="btn btn-warning btn-sm btn-sfc-del" value="删除"/>&nbsp;&nbsp;<i class="glyphicon glyphicon-ok-circle hidden check-icon"></i><div id="preview-ss-'+a+'" class="upload_preview hidden"></div><div id="progress-ss-'+a+'" class="progress z-progress hidden progress-striped"><div class="progress-bar progress-bar-success"></div></div><a class="btn btn-xs btn-primary hidden file-submit" id="app-ss-submit-'+a+'">上传</a><a class="btn btn-xs btn-danger hidden file-abort" id="app-ss-abort-'+a+'">终止</a><div class="upload_inf hidden"></div></div><input type="hidden" name="screenshot_path[]"  class="path" id="screenshot-path-'+a+'"></td><td></td></tr>'),c=$("");$("#insert-before").before(b),$("#f-input-file").append(c),h=a;var d=a;window["screenshotUploader_"+d]=Qiniu.uploader({runtimes:"html5,flash,html4",browse_button:"choose-ss-"+d,uptoken_url:"/admin/qiniu/token",domain:"tcl-cd-test.qiniudn.com",container:"container-ss-"+d,max_file_size:"100kb",flash_swf_url:"../../../../static/plugin/qiniu/js/plupload/Moxie.swf",max_retries:0,dragdrop:!1,auto_start:!1,multi_selection:!1,unique_names:!0,save_key:!0,init:{FilesAdded:function(a,b){if(b[0].type.indexOf("image")<0)return a.files.pop(),alert("请上传图片文件"),!1;if(b[0].size>102400)return a.files.pop(),alert("文件过大"),!1;a.files.length>1&&a.files.shift();var c=a.files[0],e="",f=a.settings,g=$(f.browse_button[0]),h=g.parent().parent().find(".upload_preview"),i=g.parent().parent().find(".progress-bar"),j=g.parent().parent().find(".progress"),k=g.parent().parent().find(".file-submit"),l=(g.parent().parent().find(".file-abort"),g.parent().find("i.check-icon")),m=g.parent().parent().find(".upload_inf"),n=$("#screenshot-path-"+d),o=new FileReader;o.onload=function(b){e='<div><a class="upload_delete close glyphicon glyphicon-remove" title="删除" ></a><img  src="'+b.target.result+'" class="upload_image img-thumbnail" /></div>',h.html(e).removeClass("hidden"),i.css("width","0"),j.removeClass("hidden"),g.attr("title",c.name),k.removeClass("hidden"),l.addClass("hidden"),m.html("").addClass("hidden"),h.delegate(".upload_delete","click",function(){a.files.pop(),l.addClass("hidden"),h.html("").addClass("hidden"),i.css("width","0"),j.addClass("hidden"),k.addClass("hidden"),g.attr("title","未选择文件"),n.val(""),m.html("").addClass("hidden")}),n.val(""),k[0].onclick=function(){m.html("").addClass("hidden"),window["screenshotUploader_"+d].start()}},o.readAsDataURL(c.getNative())},BeforeUpload:function(a){var b=a.settings,c=$(b.browse_button[0]),e=c.parent().parent().find(".progress"),f=c.parent().parent().find(".progress-bar"),g=c.parent().parent().find(".file-submit"),h=c.parent().parent().find(".file-abort"),i=c.parent().parent().find(".upload_delete"),j=c.parent().parent().find(".upload_inf");g.addClass("hidden"),h.removeClass("hidden"),i.addClass("hidden"),e.addClass("active"),h.click(function(){window["screenshotUploader_"+d].stop(),f.css("width","0"),$(this).addClass("hidden"),g.removeClass("hidden"),j.html('<i class="icon-warning-sign"> 文件上传失败：用户终止上传').removeClass("hidden")})},UploadProgress:function(a,b){var c=a.settings,d=$(c.browse_button[0]),e=(d.parent().parent().find(".file-abort"),d.parent().parent().find(".progress-bar"));e.css("width",b.percent+"%")},FileUploaded:function(a,b,c){var e=$.parseJSON(c);if(!e)return void bootbox.alert("上传截图失败");$("#screenshot-path-"+d).val(e.key+","+e.name);var f=a.settings,g=$(f.browse_button[0]),h=g.parent().parent().find(".progress"),i=(g.parent().parent().find(".file-submit"),g.parent().parent().find(".file-abort")),j=g.parent().parent().find(".upload_delete"),k=g.parent().find("i.check-icon");i.addClass("hidden"),j.removeClass("hidden"),k.removeClass("hidden"),h.removeClass("active")},Error:function(a,b,c){var e=a.settings,f=$(e.browse_button[0]),g=(f.parent().parent().find(".file-submit"),f.parent().parent().find(".file-abort")),h=f.parent().parent().find(".progress"),i=f.parent().parent().find(".upload_delete"),j=f.parent().find("i.check-icon"),k=$("#screenshot-path-"+d),l=f.parent().parent().find(".upload_inf");i.removeClass("hidden"),g.addClass("hidden"),j.addClass("hidden"),k.val(""),h.removeClass("active"),l.html('<i class="icon-warning-sign"> '+c).removeClass("hidden")},UploadComplete:function(){}}}),i++}),$("#app-upload-table").delegate(".btn-sfc-del","click",function(){i--,$(this).parent().parent().parent().remove()}),$("#btn-sfpak-select").click(function(){k=1;$(this).parent().parent().find("input[type='text']");$("#sfpak-file-input").click()}),$("#sfpak-file-input").change(function(){var a=$(this).parent().parent().find("input[type='text']");return $.checkFileSuffix($("#sfpak-file-input").val(),"apk")?($("#btn-sfpak-select").parent().find("img").attr("src","/static/common/images/loading.gif"),$("#btn-sfpak-select").parent().find("img").removeClass("hidden"),$.ajaxFileUpload(g("apk","sfpak-file-input","btn-sfpak-select",$("#option").attr("value"))),void a.val($(this).val())):void alert("请上传.apk文件")});var j,k=1;$(".app-modify").click(function(){a||(a=KindEditor.create("#app-desc-info",b)),a.sync(),$("#name-dsc").html(""),$("#upload-modify")[0].reset();var d=$(this).parent().parent().find("input[type='checkbox']").val();j=d;var e={url:"/admin/app/modify/"+d+"/",type:"GET",callback:function(b){var e=b.data;$("[name=name]").val(e.name),$("[name=read_count]").val(e.read_count),$("[name=download_count]").val(e.download_count),$("[name=publisher]").val(e.publisher),$("[name=app_type]").val(e.app_type);var f=e.apk.split("/"),g=f[f.length-1];$("#sfpak-input-file").val(g),$("#sfpak-input-file").parent().find("input[type=hidden]").attr("value",e.apk),$(".btn-sfc-del").parent().parent().parent().remove(),$(".upload_preview").html("").addClass("hidden"),$(".path").val(""),$(".progress").addClass("hidden"),$(".check-icon").addClass("hidden");{var j=location.href;j.substring(0,j.indexOf("admin"))}if(e.banner_icon){var k=e.banner_icon.split("/"),l=k[k.length-1];$("#choose-banner").attr("title",l);var m='<div><img  src="'+e.banner_icon+'" class="upload_image img-thumbnail" /></div>';$("#preview-banner").html(m).removeClass("hidden"),$("#banner-path").val(e.banner_icon),$("#container-banner").find(".check-icon").removeClass("hidden")}if(e.icon){var n=e.icon.split("/"),o=n[n.length-1];$("#choose-icon").attr("title",o);var p='<div><img  src="'+e.icon+'" class="upload_image img-thumbnail" /></div>';$("#preview-icon").html(p).removeClass("hidden"),$("#icon-path").val(e.icon),$("#container-icon").find(".check-icon").removeClass("hidden")}var q=e.screenshot.split(","),r=q[0].split("/"),s=r[r.length-1];$("#choose-ss-1").attr("title",s);var t='<div><img  src="'+q[0]+'" class="upload_image img-thumbnail" /></div>';$("#preview-ss-1").html(t).removeClass("hidden"),$("#screenshot-path-1").val(q[0]),$("#container-ss-1").find(".check-icon").removeClass("hidden");var u=1;i=0;for(var v=1;v<q.length;v++){var r=q[v].split("/"),s=r[r.length-1];if(u>6)break;$("#btn-sfc-add").click(),$("#choose-ss-"+h).attr("title",s),t='<div><img  src="'+q[v]+'" class="upload_image img-thumbnail" /></div>',$("#preview-ss-"+h).html(t).removeClass("hidden"),$("#screenshot-path-"+h).val(q[v]),$("#container-ss-"+h).find(".check-icon").removeClass("hidden"),u+=1}a.html(e.description),"0"==e.pay_type?($("#source_type").val(1),$("#pay_type").show(),$("[name=pay_type]").val(0),$("#price-percent").html("<td>单价</td><td><input type='text' name='price' placeholder='/' class='form-control input-sm'/></td><td></td><td></td>"),$("#price-percent").show(),$("[name=price]").val(e.price)):"1"==e.pay_type?($("#source_type").val(1),$("#pay_type").show(),$("[name=pay_type]").val(1),$("#price-percent").html("<td><span style='color: red;'>*</span>&nbsp;分成比例</td><td><input type='text' name='percent' placeholder='/' class='form-control input-sm'/></td><td></td><td></td>"),$("#price-percent").show(),$("[name=percent]").val(e.percent)):($("#source_type").val(0),$("#pay_type").hide(),$("#price-percent").hide()),$("[name=icon]").removeClass("input-must"),$("[name=apk]").removeClass("input-must"),category_list=e.category.split(",");var w="<select multiple='multiple' name='category' class='form-control input-sm' style='height: 100px;'>";$.sendAjax(c("category",w,e.app_type,category_list)),w="<select name='provider' class='form-control input-sm'>",$.sendAjax(c("provider",w,"",e.provider)),w="",language_list=e.language.split(","),$.sendAjax(c("language",w,"",language_list)),$("[name=charge_type]").val(e.charge_type),$("#upload-modify").attr("action","/admin/app/modify/"+d+"/")}};$.sendAjax(e),$.sendAjax({url:"/admin/app/show_detail/"+d+"/",type:"GET",callback:function(a){var b="包名: "+a.data.package_name+"<br>版本: "+a.data.version_name+"<br>大小: "+Math.round(a.data.size/1024/1024*100)/100+"M";$("#apkinfo").html(b)}}),$("#app-upload-modify-title").html("<i class='glyphicon glyphicon-upload'></i>App修改"),$("#option").attr("value","modify"),$("img.check").attr("src",""),$(".modal-footer").show(),$("#app-upload").modal("show")
}),$(".imgpreviews").imgPreview(),$("#upload-submit").click(function(){$("#upload-submit-real").click()}),$("#upload-submit-real").click(function(){var b=$("input[name=percent]"),c=b.val();if("1"==$("#source_type").val()&&""==c)return bootbox.alert("分成比例不能为空!"),b.focus(),!1;if($.isNull($("#icon-path").val())){var d="";return d=""===$("#preview-icon").html()?"请选择Icon":"请上传icon",bootbox.alert(d),!1}for(var e=0;e<$(".input-must").length;e++){var f=$(".input-must")[e].name;if($.isNull($(".input-must")[e].value))return bootbox.alert($(".input-must")[e].alt+"不能为空"),!1;if("icon"==f||"banner"==f||"screenshot"==f){if(!$.checkFileSuffix($(".input-must")[e].value,"img"))return alert("请选择.png或.jpg图片"),!1}else if("apk"==f&&!$.checkFileSuffix($(".input-must")[e].value,"apk"))return alert($(".input-must")[e].alt+"请选择.apk文件"),!1}if(!$.isInteger($("[name=read_count]").val())&&""!=$.trim($("[name=read_count]").val()))return bootbox.alert("阅读次数必须为整数"),!1;if(Number($("[name=read_count]").val())>999999999&&""!=$.trim($("[name=read_count]").val()))return bootbox.alert("阅读次数超过范围(长度最多为9位)"),!1;if(!$.isInteger($("[name=download_count]").val())&&""!=$.trim($("[name=download_count]").val()))return bootbox.alert("下载次数必须为整数"),!1;if(Number($("[name=download_count]").val())>999999999&&""!=$.trim($("[name=download_count]").val()))return bootbox.alert("下载次数超过范围(长度最多为9位)"),!1;if(0==$("select[name=category] option:selected").length)return bootbox.alert("请选择分类"),!1;for(var g=!1,e=0;e<$("[name='checked[]']").length;e++)if($("[name='checked[]']")[e].checked){g=!0;break}if(a.isEmpty())return bootbox.alert("内容介绍不能为空"),!1;var h=a.html();h=h.replace(/(<p>\s*<br \/>\s*<\/p>\s*)*\s*$/g,""),a.html(h),a.sync();for(var e=0;e<$("img.check").length;e++){if(re_error=/.*error.png$/,re_loading=/.*loading.gif$/,re_error.test($("img.check")[e].src))return bootbox.alert("请改正错误信息"),!1;if(re_loading.test($("img.check")[e].src))return bootbox.alert("正在上传文件,请等待..."),!1}var i=$("input[name='screenshot_path[]']"),k=0;if(i.each(function(){""!==$(this).val()&&k++}),3>k)return bootbox.alert("上传软件截图必须大于3张!"),!1;if("upload"==$("#option").val())var l="/admin/app/upload/";else if("modify"==$("#option").val())var l="/admin/app/modify/"+j+"/";var m={url:l,type:"post",dataType:"text",data:$("#upload-modify").serialize(),success:function(a){a=JSON.parse(a),"success"==a.status?($("#upload-submit").attr("disabled",!1),$("#upload-submit").find("img").addClass("hidden"),bootbox.alert(a.msg),location.href=window.location.protocol+"//"+window.location.host+"/admin/app/?app_name="+a.apk_name):(bootbox.alert(a.msg),$("#upload-submit").attr("disabled",!1),$("#upload-submit").find("img").addClass("hidden"),$("#app-upload").modal("hidden"))},error:function(){bootbox.alert("服务器错误")}};$.ajax(m),$("#upload-submit").attr("disabled",!0),$("#upload-submit").find("img").removeClass("hidden")}),$(".sort").click(function(){var a=$(this).attr("value").split(":"),b=window.location.protocol+"//"+window.location.host,c=location.href,d=/sort/,e="";b+="/admin/resource/sort/1?sortName="+a[0]+"&sortModel="+a[1],e=d.test(c)&&-1!=c.indexOf("app_name")?c.substring(c.indexOf("app_name"),c.length):-1!=c.indexOf("?")?c.substring(c.indexOf("?")+1,c.length):"",e&&(b+="&"+e),location.href=b}),$(".btn-sf-detail").click(function(){var a=$(this).attr("name"),b={url:"/admin/app/show_detail/"+a+"/",type:"GET",callback:function(a){var b=a.data;$("#sf-name").html(b.name),$("#sf-price-type").html(b.price_type),$("#sf-price").html(b.price),$("#sf-provider").html(b.provider),$("#sf-res-type").html(b.pay_type),$("#sf-res-category").html(b.app_type),$("#sf-desc").html(b.description),$("#sf-read-count").html(b.read_count),$("#sf-download-count").html(b.downlod_count),$("#sf-version").html(b.version_name),$("#sf-update-date").html(b.update_time),$("#sf-screenshot").html("");for(var c=b.screenshot,d=c.split(","),e=0;e<d.length;e++){var f=document.createElement("img");f.src=d[e],f.alt=b.name+"-截图"+(e+1),f.width=100,document.getElementById("sf-screenshot").appendChild(f)}$("#sf-detail-modal").modal("show"),$(".modal-footer").hide()}};$.sendAjax(b)})});