/*! appstore */
function reset_add_subject_form(){$("#input-subject-id").val("-1"),$("#subject-name-check").html("<small>专题名称建议不超过14个字</small>"),$("#add-subject-name").val(""),$("#selected-subject-icon").val(""),$("#input-subject-banner").val(""),$("#input-subject-icon").val(""),$("#btn-subject-banner").parent().find("img").attr("src",""),$("#btn-subject-icon").parent().find("img").attr("src",""),$("#recommend_app_1").val(""),$("#recommend_app_2").val(""),$("#subject-description").val(""),$("#operate-subject-title").html("增加专题"),$(".upload_preview").html("").addClass("hidden"),$(".check-icon").addClass("hidden"),$(".fileinput-button").attr("title","未选择文件")}function is_iE(){return!!window.ActiveXObject}$(function(){bootbox.setDefaults({locale:"zh_CN"});var a,b={width:"100%",height:"270",items:["fontname","fontsize","|","forecolor","bold","italic","underline","|","justifyleft","justifycenter","justifyright","justifyfull","|","insertorderedlist","insertunorderedlist","|","indent","outdent"],resizeType:0};$.selectAllToggle("sbj-check","sbj-check-item"),$("#btn-sbj-add").click(function(){reset_add_subject_form(),a||(a=KindEditor.create("#subject-description",b))}),$("#btn-sbj-sw").click(function(){$(".choose-box .jtree").html(""),$(".result-box .jtree").html(""),$(".selected-count").html("0");var a=$.checkboxVal("sbj-check-item");if(a.length>0){var b={url:"/admin/subject/throw/",type:"GET",callback:function(a){$("#sj-throw").checkboxTree(a.data,"subject-throw-node")}};$.sendAjax(b),$("#sbj-throw").modal("show")}else bootbox.alert("请先选择专题，然后才能进行投放!",function(){})}),$("#sj-throw").delegate(".add-block","click",function(){var a,b;if($(this).parent().find("ul.has-children").length){if(a=$(this).parent().attr("data-id"),b=$(this).parent().attr("data-txt"),!$(".result-box").find("li[data-id="+a+"]").length){var c=$('<li class="list-group-item cate" data-id="'+a+'">'+b+'<a class="glyphicon glyphicon-chevron-left pull-right remove-block" title="移除版块"></a><ul class="has-children"></ul></li>');c.appendTo($(".result-box ul.jtree"))}var d=parseInt($(".selected-count").html())+$(this).parent().find("ul.has-children>li").length;$(this).parent().find("ul.has-children>li").appendTo($(".result-box").find("li[data-id="+a+"] ul.has-children")),$(".selected-count").html(d),$(this).parent().find(".j-switch .glyphicon").hasClass("glyphicon-plus")&&$(this).parent().find(".j-switch").click()}else{if(a=$(this).parent().attr("data-id"),b=$(".choose-box").find("li.list-group-item[data-id=-1]").attr("data-txt"),!$(".result-box").find("li[data-id=-1]").length){var c=$('<li class="list-group-item cate" data-id="-1">'+b+'<a class="glyphicon glyphicon-chevron-left pull-right remove-block" title="移除版块"></a><ul class="has-children"></ul></li>');c.appendTo($(".result-box ul.jtree"))}$(this).parent().appendTo($(".result-box").find("li[data-id=-1] ul.has-children"));var d=parseInt($(".selected-count").html())+1;$(".selected-count").html(d)}}),$(".result-box").delegate(".remove-block","click",function(){var a,b,c;if($(this).parent().find("ul.has-children").length)a=$(this).parent().attr("data-id"),b=$(".choose-box").find("li.list-group-item[data-id="+a+"]").find("ul.has-children"),c=parseInt($(".selected-count").html())-$(this).parent().find("ul.has-children>li").length,$(this).parent().find("ul.has-children li").appendTo(b),$(this).parent().remove();else{a=$(this).parent().attr("data-id").split("-")[0],b=$(".choose-box").find("li.list-group-item[data-id=-1]").find("ul.has-children");var d=$(this).parent();1==$(this).parent().parent().find("li").length&&$(this).parent().parent().parent().remove(),d.appendTo(b),c=parseInt($(".selected-count").html())-1}$(".selected-count").html(c)}),$("#throw-yes-btn").click(function(){var a=[];$(".result-box li").each(function(){a.push($(this).attr("data-id"))}),console.log(a);var b=$.checkboxVal("sbj-check-item");if(1==a.length&&"-1"==a[0])return void bootbox.alert("请选择要投放到的模块!",function(){});if(a.length>0){var c={};c.subject_ids=b,c.checked_nodes=a;var d={url:"/admin/subject/throw/",data:c};$.sendAjax(d)}else bootbox.alert("请选择要投放到的模块!",function(){})}),$(".btn-sbj-offshelf").click(function(){var a=$(this).attr("value");bootbox.confirm("请确定是否下架所选专题?",function(b){if(b){var c={url:"/admin/subject/offshelf/",data:{subject_id:a}};$.sendAjax(c)}})}),$(".btn-sbj-onshelf").click(function(){var a=$(this).attr("value");bootbox.confirm("请确定是否上架所选专题?",function(b){if(b){var c={url:"/admin/subject/onshelf/",data:{subject_id:a}};$.sendAjax(c)}})}),$("#btn-sbj-del").click(function(){var a=$.checkboxVal("sbj-check-item");a.length>0?bootbox.confirm("请确定是否删除所选专题?",function(b){if(b){var c={url:"/admin/subject/delete/",data:{subject_ids:a}};$.sendAjax(c)}}):bootbox.alert("请先选择专题，然后才能进行删除操作!",function(){})}),$.selectAllToggle("slist-check","slist-check-item"),$("#add-subject-name").blur(function(){$.isNull($.trim($(this).val()))?$("#subject-name-check").html("<small>专题名称建议不超过14个字</small>"):$.strLength($.trim($(this).val()),1)&&$.sendAjax({url:"/admin/subject/title/check/",type:"POST",data:{title:$.trim($(this).val()),subject_id:$("#input-subject-id").val()},callback:function(a){$("#subject-name-check").html("success"==a.status?"<img src='/static/common/images/right.png' />":"<img src='/static/common/images/error.png' /><span class='label label-warning'>"+a.msg+"</span>")}})});var c=Qiniu.uploader({runtimes:"html5,flash,html4",browse_button:"choose-icon",uptoken_url:"/admin/qiniu/token",domain:"tcl-cd-test.qiniudn.com",container:"container-icon",max_file_size:"100kb",flash_swf_url:"../../../../static/plugin/qiniu/js/plupload/Moxie.swf",max_retries:0,dragdrop:!1,auto_start:!1,multi_selection:!1,unique_names:!0,save_key:!0,init:{FilesAdded:function(a,b){if(b[0].type.indexOf("image")<0)return a.files.pop(),alert("请上传图片文件"),!1;a.files.length>1&&a.files.shift();var d=a.files[0],e="",f=a.settings,g=$(f.browse_button[0]),h=g.parent().parent().find(".upload_preview"),i=g.parent().parent().find(".progress-bar"),j=g.parent().parent().find(".progress"),k=g.parent().parent().find(".file-submit"),l=(g.parent().parent().find(".file-abort"),g.parent().find("i.check-icon")),m=g.parent().parent().find(".upload_inf"),n=$("#icon-path"),o=new FileReader;o.onload=function(b){e='<div><a class="upload_delete close glyphicon glyphicon-remove" title="删除"></a><img  src="'+b.target.result+'" class="upload_image img-thumbnail" /></div>',h.html(e).removeClass("hidden"),i.css("width","0"),j.removeClass("hidden"),g.attr("title",d.name),k.removeClass("hidden"),l.addClass("hidden"),m.html("").addClass("hidden"),h.delegate(".upload_delete","click",function(){a.files.pop(),l.addClass("hidden"),h.html("").addClass("hidden"),i.css("width","0"),j.addClass("hidden"),k.addClass("hidden"),g.attr("title","未选择文件"),n.val(""),m.html("").addClass("hidden")}),n.val(""),k[0].onclick=function(){m.html("").addClass("hidden"),c.start()}},o.readAsDataURL(d.getNative())},BeforeUpload:function(a){var b=a.settings,d=$(b.browse_button[0]),e=d.parent().parent().find(".progress"),f=d.parent().parent().find(".progress-bar"),g=d.parent().parent().find(".file-submit"),h=d.parent().parent().find(".file-abort"),i=d.parent().parent().find(".upload_delete"),j=d.parent().parent().find(".upload_inf");g.addClass("hidden"),h.removeClass("hidden"),i.addClass("hidden"),e.addClass("active"),h.click(function(){c.stop(),f.css("width","0"),$(this).addClass("hidden"),g.removeClass("hidden"),j.html('<i class="icon-warning-sign"> 文件上传失败：用户终止上传').removeClass("hidden")})},UploadProgress:function(a,b){var c=a.settings,d=$(c.browse_button[0]),e=(d.parent().parent().find(".file-abort"),d.parent().parent().find(".progress-bar"));e.css("width",b.percent+"%")},FileUploaded:function(a,b,c){var d=$.parseJSON(c);if(!d)return void bootbox.alert("上传专题icon文件失败");$("#icon-path").val(d.key+","+d.name);var e=a.settings,f=$(e.browse_button[0]),g=f.parent().parent().find(".progress"),h=(f.parent().parent().find(".file-submit"),f.parent().parent().find(".file-abort")),i=f.parent().parent().find(".upload_delete"),j=f.parent().find("i.check-icon");h.addClass("hidden"),i.removeClass("hidden"),j.removeClass("hidden"),g.removeClass("active")},Error:function(a,b,c){var d=a.settings,e=$(d.browse_button[0]),f=(e.parent().parent().find(".file-submit"),e.parent().parent().find(".file-abort")),g=e.parent().parent().find(".progress"),h=e.parent().parent().find(".upload_delete"),i=e.parent().find("i.check-icon"),j=$("#video_cover_name"),k=e.parent().parent().find(".upload_inf");h.removeClass("hidden"),f.addClass("hidden"),i.addClass("hidden"),j.val(""),g.removeClass("active"),k.html('<i class="icon-warning-sign"> '+c).removeClass("hidden")},UploadComplete:function(){}}}),d=Qiniu.uploader({runtimes:"html5,flash,html4",browse_button:"choose-banner",uptoken_url:"/admin/qiniu/token",domain:"tcl-cd-test.qiniudn.com",container:"container-banner",max_file_size:"1mb",flash_swf_url:"../../../../static/plugin/qiniu/js/plupload/Moxie.swf",max_retries:0,dragdrop:!1,auto_start:!1,multi_selection:!1,unique_names:!0,save_key:!0,init:{FilesAdded:function(a,b){if(b[0].type.indexOf("image")<0)return a.files.pop(),alert("请上传图片文件"),!1;a.files.length>1&&a.files.shift();var c=a.files[0],e="",f=a.settings,g=$(f.browse_button[0]),h=g.parent().parent().find(".upload_preview"),i=g.parent().parent().find(".progress-bar"),j=g.parent().parent().find(".progress"),k=g.parent().parent().find(".file-submit"),l=(g.parent().parent().find(".file-abort"),g.parent().find("i.check-icon")),m=g.parent().parent().find(".upload_inf"),n=$("#banner-path"),o=new FileReader;o.onload=function(b){e='<div><a class="upload_delete close glyphicon glyphicon-remove" title="删除" ></a><img  src="'+b.target.result+'" class="upload_image img-thumbnail" /></div>',h.html(e).removeClass("hidden"),i.css("width","0"),j.removeClass("hidden"),g.attr("title",c.name),k.removeClass("hidden"),l.addClass("hidden"),m.html("").addClass("hidden"),h.delegate(".upload_delete","click",function(){a.files.pop(),l.addClass("hidden"),h.html("").addClass("hidden"),i.css("width","0"),j.addClass("hidden"),k.addClass("hidden"),g.attr("title","未选择文件"),n.val(""),m.html("").addClass("hidden")}),n.val(""),k[0].onclick=function(){m.html("").addClass("hidden"),d.start()}},o.readAsDataURL(c.getNative())},BeforeUpload:function(a){var b=a.settings,c=$(b.browse_button[0]),e=c.parent().parent().find(".progress"),f=c.parent().parent().find(".progress-bar"),g=c.parent().parent().find(".file-submit"),h=c.parent().parent().find(".file-abort"),i=c.parent().parent().find(".upload_delete"),j=c.parent().parent().find(".upload_inf");g.addClass("hidden"),h.removeClass("hidden"),i.addClass("hidden"),e.addClass("active"),h.click(function(){d.stop(),f.css("width","0"),$(this).addClass("hidden"),g.removeClass("hidden"),j.html('<i class="icon-warning-sign"> 文件上传失败：用户终止上传').removeClass("hidden")})},UploadProgress:function(a,b){var c=a.settings,d=$(c.browse_button[0]),e=(d.parent().parent().find(".file-abort"),d.parent().parent().find(".progress-bar"));e.css("width",b.percent+"%")},FileUploaded:function(a,b,c){var d=$.parseJSON(c);if(!d)return void bootbox.alert("上传专题banner文件失败");$("#banner-path").val(d.key+","+d.name);var e=a.settings,f=$(e.browse_button[0]),g=f.parent().parent().find(".progress"),h=(f.parent().parent().find(".file-submit"),f.parent().parent().find(".file-abort")),i=f.parent().parent().find(".upload_delete"),j=f.parent().find("i.check-icon");h.addClass("hidden"),i.removeClass("hidden"),j.removeClass("hidden"),g.removeClass("active")},Error:function(a,b,c){var d=a.settings,e=$(d.browse_button[0]),f=(e.parent().parent().find(".file-submit"),e.parent().parent().find(".file-abort")),g=e.parent().parent().find(".progress"),h=e.parent().parent().find(".upload_delete"),i=e.parent().find("i.check-icon"),j=$("#video_cover_name"),k=e.parent().parent().find(".upload_inf");h.removeClass("hidden"),f.addClass("hidden"),i.addClass("hidden"),j.val(""),g.removeClass("active"),k.html('<i class="icon-warning-sign"> '+c).removeClass("hidden")},UploadComplete:function(){}}});$("#btn-add-subject").click(function(){$("#btn-add-subject-real").click()}),$("#btn-add-subject-real").click(function(){if(""!=$.trim($("#add-subject-name").val())&&$.sendAjax({url:"/admin/subject/title/check/",type:"POST",data:{title:$.trim($("#add-subject-name").val()),subject_id:$("#input-subject-id").val()},sync:!1,callback:function(a){$("#subject-name-check").html("success"==a.status?"<img src='/static/common/images/right.png' />":"<img src='/static/common/images/error.png' /><span class='label label-warning'>"+a.msg+"</span>")}}),"/static/common/images/right.png"!=$("#subject-name-check").find("img").attr("src"))return bootbox.alert("无效的专题名"),!1;if($.isNull($("#icon-path").val())){var b="";return b=""===$("#preview-icon").html()?"请选择Icon":"请上传icon",bootbox.alert(b),!1}if(!$.strLength($.trim($("#recommend_app_1").val()),14)||!$.strLength($.trim($("#recommend_app_2").val()),14))return bootbox.alert("推荐应用字数不能超过14个"),!1;if(a.isEmpty())return bootbox.alert("专题描述不能为空"),!1;var c=a.html();c=c.replace(/(<p>\s*<br \/>\s*<\/p>\s*)*\s*$/g,""),a.html(c),a.sync()}),$(".btn-modify-subject").click(function(){reset_add_subject_form(),a||(a=KindEditor.create("#subject-description",b)),$.sendAjax({url:"/admin/subject/info/",type:"POST",data:{subject_id:$(this).attr("value")},callback:function(b){if("success"==b.status){$("#input-subject-id").val(b.id),$("#add-subject-name").val(b.title),$("#subject-name-check").html("<img src='/static/common/images/right.png' />");var c='<div><img  src="'+b.icon+'" class="upload_image img-thumbnail" /></div>',d='<div><img  src="'+b.banner_icon+'" class="upload_image img-thumbnail" /></div>';$("#icon-path").val(b.icon),$("#banner-path").val(b.banner_icon),$("#preview-icon").html(c).removeClass("hidden"),$("#preview-banner").html(d).removeClass("hidden"),$(".check-icon").removeClass("hidden"),$("#choose-icon").attr("title",b.icon),$("#choose-banner").attr("title",b.banner_icon),$("#recommend_app_1").val(b.demo_app[0]),$("#recommend_app_2").val(b.demo_app[1]),$("#operate-subject-title").html("修改专题"),a.html(b.description)}else bootbox.alert(b.msg)}}),$("#sbj-add").modal("show")}),$(".imgpreviews").imgPreview(),$(".update-subject-app-comment").change(function(){var a=$("#btn-subject-app-list").attr("value"),b=$(this).parent().parent().find("input[type='checkbox']").val();params={url:"/admin/subject/list/comment/update/"+a,data:{app_id:b,comment:$(this).val()}},$.sendAjax(params)}),$(".update-subject-app-priority").update("/admin/subject/list/priority/update/"+$("#btn-subject-app-list").attr("value")+"/"),$(".update-subject-priority").update("/admin/subject/priority/update/"),$.selectAllToggle("app-check","app-check-item"),$("#btn-subject-app-list").click(function(){var a=$.checkboxVal("app-check-item"),b=$(this).attr("value");a.length>0?bootbox.confirm("选择下架后，你投放的资源将被移除，是否继续？",function(c){if(c){var d={url:"/admin/offshelf_app_from_subject/"+b+"/",data:{app_ids:a}};$.sendAjax(d)}}):bootbox.alert("请先选择，然后才能进行下架操作!",function(){})})});